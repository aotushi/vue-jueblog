# Vue JueBlog V2 升级计划 - tRPC + Hono + Cloudflare

## 🎯 目标

将项目升级为现代化的全栈 TypeScript 架构：

- **后端**: Hono + tRPC + Cloudflare Workers
- **前端**: Vue 3 + tRPC Client + 现代化 Mock 方案
- **部署**: Cloudflare Workers (边缘计算)

## 📋 详细计划

### 🔍 第一阶段：技术预研 (Week 1-2)

#### 1. 学习 tRPC + Hono + Cloudflare Workers 技术栈

- **tRPC 核心概念**: Router, Procedure, Context, Middleware
- **Hono 框架**: 现代化 Web 框架，Cloudflare Workers 原生支持
- **Cloudflare Workers**: 边缘计算平台，全球分发
- **学习资源**:
  - [tRPC 官方文档](https://trpc.io/docs)
  - [Hono 官方文档](https://hono.dev/)
  - [Cloudflare Workers 文档](https://developers.cloudflare.com/workers/)

#### 2. 研究前端 Mock 数据最佳实践方案

**当前问题**: `backend-mockdata` 繁琐
**推荐方案**:

- **MSW (Mock Service Worker)**: 拦截网络请求，无侵入性
- **Mirage.js**: 功能强大的前端 API mock 库
- **json-server**: 简单快速的 REST API mock
- **Vite Mock Plugin**: Vite 生态的 mock 解决方案

#### 3. 设计 Cloudflare 部署架构和环境配置

```
架构设计:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Vue 3 SPA     │───▶│ Cloudflare      │───▶│ External DB     │
│   (Static)      │    │ Workers         │    │ (PlanetScale/   │
│                 │    │ (Hono + tRPC)   │    │  Supabase)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 🏗️ 第二阶段：服务端开发 (Week 3-4)

#### 4. 搭建 Hono + tRPC 服务端基础框架

```typescript
// 项目结构
server/
├── src/
│   ├── trpc/
│   │   ├── router.ts
│   │   ├── context.ts
│   │   └── middleware.ts
│   ├── routes/
│   │   ├── users.ts
│   │   ├── articles.ts
│   │   └── comments.ts
│   └── index.ts (Hono app)
├── wrangler.toml
└── package.json
```

#### 5. 配置 Cloudflare Workers 开发环境

- 安装 Wrangler CLI
- 配置 `wrangler.toml`
- 设置本地开发环境
- 配置环境变量和密钥

#### 6-8. 实现 tRPC 接口 (Hono)

**用户模块**:

```typescript
export const userRouter = router({
  login: publicProcedure
    .input(z.object({ phone: z.string(), password: z.string() }))
    .mutation(async ({ input, ctx }) => {
      /* ... */
    }),
  register: publicProcedure.input(registerSchema).mutation(/* ... */),
  getProfile: protectedProcedure.input(z.string()).query(/* ... */),
})
```

**文章模块**:

```typescript
export const articleRouter = router({
  list: publicProcedure.input(listSchema).query(/* ... */),
  detail: publicProcedure.input(z.string()).query(/* ... */),
  create: protectedProcedure.input(articleSchema).mutation(/* ... */),
  update: protectedProcedure.input(updateSchema).mutation(/* ... */),
})
```

### 🎨 第三阶段：前端改造 (Week 5-6)

#### 9. 配置前端现代化 Mock 数据方案

**推荐: MSW (Mock Service Worker)**

```typescript
// mocks/handlers.ts
export const handlers = [
  http.get('/api/articles', () => {
    return HttpResponse.json(mockArticles)
  }),
  http.post('/api/users/login', () => {
    return HttpResponse.json({ token: 'mock-token' })
  }),
]

// 开发环境自动启用
if (import.meta.env.DEV) {
  const { worker } = await import('./mocks/browser')
  worker.start()
}
```

#### 10. 配置前端 tRPC 客户端连接 Hono 服务

```typescript
// utils/trpc.ts
import { createTRPCVue } from '@trpc/vue'
import { httpBatchLink } from '@trpc/client'

export const trpc = createTRPCVue<AppRouter>({
  links: [
    httpBatchLink({
      url: import.meta.env.PROD
        ? 'https://your-worker.your-subdomain.workers.dev'
        : 'http://localhost:8787',
    }),
  ],
})
```

#### 11-12. 改造 Pinia Stores 和页面组件

```typescript
// stores/article.ts
export const useArticleStore = defineStore('article', () => {
  const { $trpc } = useNuxtApp()

  const getArticlesList = async (params: ListParams) => {
    return await $trpc.articles.list.query(params)
  }

  return { getArticlesList }
})
```

### 🗄️ 第四阶段：数据库和部署 (Week 7)

#### 13. 配置数据库方案

**选项对比**:

- **Cloudflare D1**: 官方 SQLite，免费额度大
- **PlanetScale**: MySQL 兼容，分支管理
- **Supabase**: PostgreSQL，实时功能
- **MongoDB Atlas**: NoSQL，现有数据兼容

#### 14. 本地开发环境与 Cloudflare 环境联调

- 配置 `wrangler dev`
- 环境变量管理
- 数据库连接配置
- CORS 和跨域处理

#### 15. Cloudflare Workers 部署和域名配置

```bash
# 部署命令
wrangler publish

# 自定义域名
wrangler route add "api.yourdomain.com/*" your-worker
```

### ✅ 第五阶段：优化和完善 (Week 8)

#### 16. 性能优化和错误处理完善

- tRPC 缓存策略
- 错误边界处理
- 类型安全验证
- 性能监控

#### 17. 更新项目文档和部署说明

- API 文档自动生成
- 部署流程文档
- 开发环境搭建指南
- 故障排查手册

## 🛠️ 技术栈对比

| 技术      | V1 (当前)        | V2 (目标)          |
| --------- | ---------------- | ------------------ |
| 后端框架  | Express          | Hono               |
| API 类型  | REST             | tRPC               |
| 部署平台  | 传统服务器       | Cloudflare Workers |
| Mock 方案 | backend-mockdata | MSW                |
| 类型安全  | 部分             | 端到端             |
| 开发体验  | 一般             | 极佳               |
| 性能      | 一般             | 优秀               |

## 📅 时间安排

- **Week 1-2**: 技术学习和方案调研
- **Week 3-4**: 后端 Hono + tRPC 开发
- **Week 5-6**: 前端改造和 Mock 配置
- **Week 7**: 数据库和部署配置
- **Week 8**: 测试优化和文档完善

## 🚀 预期收益

1. **开发效率**: 端到端类型安全，自动补全
2. **部署成本**: Cloudflare Workers 免费额度大
3. **性能提升**: 边缘计算，全球分发
4. **维护性**: 现代化架构，代码质量高
5. **扩展性**: 模块化设计，易于扩展
